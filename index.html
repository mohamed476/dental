<!DOCTYPE html>
<html lang="ar" dir="rtl" id="html">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø¹ÙŠØ§Ø¯Ø© Ø§Ù„Ø§Ø¨ØªØ³Ø§Ù…Ø© Ø§Ù„Ù…Ø«Ø§Ù„ÙŠØ©</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><path fill='%23ffffff' stroke='%23000000' stroke-width='2' d='M32 6c9 0 20 6 20 18 0 12-7 14-9 22-2 8-3 12-7 12-4 0-5-6-6-10-1-4-1-6-3-6s-2 2-3 6c-1 4-2 10-6 10-4 0-5-4-7-12-2-8-9-10-9-22C2 12 13 6 22 6c4 0 6 2 10 2s6-2 10-2z'/></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    @keyframes glow {
      0%, 100% { box-shadow: 0 0 5px rgba(34, 197, 94, 0.5); }
      50% { box-shadow: 0 0 20px rgba(34, 197, 94, 0.8), 0 0 30px rgba(34, 197, 94, 0.6); }
    }
    @keyframes sparkle {
      0%, 100% { opacity: 1; transform: scale(1) rotate(0deg); }
      50% { opacity: 0.5; transform: scale(1.2) rotate(180deg); }
    }
    .tool:hover {
      transform: scale(1.1);
      animation: float 2s ease-in-out infinite;
    }
    .tool.dragging {
      transform: scale(1.2);
      animation: glow 1s ease-in-out infinite;
    }
    .tooth.healthy {
      animation: sparkle 3s ease-in-out infinite;
    }
    .game-area {
      background: linear-gradient(135deg, #4b5563 0%, #6b7280 100%);
      border-radius: 20px;
      padding: 2rem;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }
    .stats-card {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    canvas { touch-action: none; border-radius: 8px; }
    .legend-img { width: 24px; height: 24px; font-size: 24px; line-height: 24px; text-align: center; }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(to bottom right, #6b7280, #4b5563, #374151);
      min-height: 100vh;
      padding: 1rem;
    }
  </style>
</head>
<body>
  <div class="max-w-4xl mx-auto">
    <!-- Encabezado -->
    <div class="text-center mb-8">
      <h1 class="text-5xl font-bold bg-gradient-to-r from-cyan-300 to-purple-300 bg-clip-text text-transparent mb-4" id="title">Ø¹ÙŠØ§Ø¯Ø© Ø§Ù„Ø§Ø¨ØªØ³Ø§Ù…Ø© Ø§Ù„Ù…Ø«Ø§Ù„ÙŠØ© ğŸ¦·</h1>
      <select id="langSelect" class="mb-6 p-3 bg-white/20 backdrop-blur border border-white/30 rounded-lg text-white" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ØºØ©">
        <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
        <option value="es">EspaÃ±ol</option>
        <option value="en">English</option>
      </select>
      <div class="flex justify-center gap-4 mb-6">
        <div class="stats-card rounded-xl px-6 py-3">
          <div class="text-2xl font-bold text-cyan-200" id="points">0</div>
          <div class="text-sm text-white/80" id="pointsLabel">Ù†Ù‚Ø§Ø· Ø§Ù„ØµØ­Ø©</div>
        </div>
        <div class="stats-card rounded-xl px-6 py-3">
          <div class="text-2xl font-bold text-green-200" id="patients">0</div>
          <div class="text-sm text-white/80" id="patientsLabel">Ø§Ù„Ù…Ø±Ø¶Ù‰</div>
        </div>
        <div class="stats-card rounded-xl px-6 py-3">
          <div class="text-2xl font-bold text-purple-200" id="level">1</div>
          <div class="text-sm text-white/80" id="levelLabel">Ø§Ù„Ù…Ø³ØªÙˆÙ‰</div>
        </div>
      </div>
      <div class="flex justify-center gap-4">
        <button id="startBtn" class="bg-gradient-to-r from-green-400 to-emerald-500 text-white px-8 py-4 rounded-xl hover:from-green-500 hover:to-emerald-600 transition-all duration-300 shadow-lg transform hover:scale-105" aria-label="Ø¨Ø¯Ø¡ Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©">ğŸš€ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ù„Ø§Ø¬</button>
        <button id="helpBtn" class="bg-white/20 backdrop-blur text-white px-8 py-4 rounded-xl hover:bg-white/30 transition-all duration-300" aria-label="Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©">â“ Ù…Ø³Ø§Ø¹Ø¯Ø©</button>
      </div>
    </div>

    <!-- Ãrea de Juego -->
    <div class="game-area mb-8">
      <div class="text-center mb-6">
        <h2 class="text-2xl font-bold text-white mb-4" id="toolsTitle">ğŸ› ï¸ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø£Ø³Ù†Ø§Ù†</h2>
        <canvas id="canvas" width="400" height="300" class="mx-auto" aria-label="Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù„Ø¹Ø¨"></canvas>
      </div>
    </div>

    <!-- Leyenda y Chat -->
    <div class="grid md:grid-cols-2 gap-6">
      <!-- Leyenda -->
      <div class="stats-card rounded-2xl p-6">
        <h3 class="text-xl font-bold text-white mb-4" id="legendTitle">ğŸ“‹ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</h3>
        <div class="space-y-3 text-white/90">
          <div class="flex items-center gap-3">
            <span class="legend-img" id="iconDrill"></span>
            <span id="legendDrill">Ø§Ù„ØªÙˆØ±Ø¨ÙŠÙ†: Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ³ÙˆØ³</span>
          </div>
          <div class="flex items-center gap-3">
            <span class="legend-img" id="iconCleaner"></span>
            <span id="legendCleaner">Ø§Ù„Ù…Ù†Ø¸Ù: Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ù‚Ø¹</span>
          </div>
          <div class="flex items-center gap-3">
            <span class="legend-img" id="iconFluoride"></span>
            <span id="legendFluoride">Ø§Ù„ÙÙ„ÙˆØ±Ø§ÙŠØ¯: Ù„ØªÙ‚ÙˆÙŠØ© Ø§Ù„Ø£Ø³Ù†Ø§Ù†</span>
          </div>
          <div class="flex items-center gap-3">
            <span class="legend-img" id="iconHealthy"></span>
            <span id="legendHealthy">Ø³Ù† Ø³Ù„ÙŠÙ…: Ù„Ø§ ÙŠØ­ØªØ§Ø¬ Ø¹Ù„Ø§Ø¬</span>
          </div>
          <div class="flex items-center gap-3">
            <span class="legend-img" id="iconCaries"></span>
            <span id="legendCaries">Ø³Ù† Ù…ØªØ³ÙˆØ³: Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªÙˆØ±Ø¨ÙŠÙ†</span>
          </div>
          <div class="flex items-center gap-3">
            <span class="legend-img" id="iconStained"></span>
            <span id="legendStained">Ø³Ù† Ù…Ù„Ø·Ø®: Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ù†Ø¸Ù</span>
          </div>
        </div>
      </div>

      <!-- Chat -->
      <div class="stats-card rounded-2xl p-6">
        <div class="flex items-center mb-4">
          <div class="w-12 h-12 bg-gradient-to-r from-cyan-300 to-purple-300 rounded-full flex items-center justify-center mr-3">
            <span class="text-2xl">ğŸ‘¨â€âš•ï¸</span>
          </div>
          <h3 class="text-xl font-bold text-white" id="chatTitle">Ø¯. Ø¢Ù…Ù†Ø© Ø§Ù„Ø¬ÙˆØ§Ø¯ÙŠ</h3>
        </div>
        <div id="chatBox" class="h-32 overflow-y-auto bg-white/10 rounded-lg p-3 mb-4 backdrop-blur border border-white/20 text-white text-sm" aria-live="polite"></div>
        <div class="flex gap-2">
          <input id="userInput" type="text" class="flex-1 p-3 bg-white/20 border border-white/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-300 text-white placeholder-gray-200 backdrop-blur" placeholder="Ø§Ø³Ø£Ù„ Ø§Ù„Ø·Ø¨ÙŠØ¨..." aria-label="Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¯Ø±Ø¯Ø´Ø©">
          <button id="sendBtn" class="bg-gradient-to-r from-cyan-400 to-purple-500 text-white px-4 py-3 rounded-lg hover:from-cyan-500 hover:to-purple-600 transition-all duration-300" aria-label="Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©">ğŸ“¨</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ConfiguraciÃ³n del lienzo
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const pointsEl = document.getElementById('points');
    const patientsEl = document.getElementById('patients');
    const levelEl = document.getElementById('level');
    const startBtn = document.getElementById('startBtn');
    const helpBtn = document.getElementById('helpBtn');
    const langSelect = document.getElementById('langSelect');
    const chatBox = document.getElementById('chatBox');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');

    let points = 0;
    let patients = 0;
    let level = 1;
    let gameActive = false;
    let selectedTool = null;
    let language = 'ar';

    // Traducciones
    const translations = {
      ar: {
        title: 'Ø¹ÙŠØ§Ø¯Ø© Ø§Ù„Ø§Ø¨ØªØ³Ø§Ù…Ø© Ø§Ù„Ù…Ø«Ø§Ù„ÙŠØ© ğŸ¦·',
        startBtn: 'ğŸš€ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ù„Ø§Ø¬',
        restartBtn: 'ğŸ”„ Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯',
        helpBtn: 'â“ Ù…Ø³Ø§Ø¹Ø¯Ø©',
        toolsTitle: 'ğŸ› ï¸ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø£Ø³Ù†Ø§Ù†',
        patientTitle: 'ğŸ‘¤ Ø§Ù„Ù…Ø±ÙŠØ¶ Ø§Ù„Ø­Ø§Ù„ÙŠ',
        legendTitle: 'ğŸ“‹ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©',
        chatTitle: 'Ø¯. Ø¢Ù…Ù†Ø© Ø§Ù„Ø¬ÙˆØ§Ø¯ÙŠ',
        pointsLabel: 'Ù†Ù‚Ø§Ø· Ø§Ù„ØµØ­Ø©',
        patientsLabel: 'Ø§Ù„Ù…Ø±Ø¶Ù‰',
        levelLabel: 'Ø§Ù„Ù…Ø³ØªÙˆÙ‰',
        legendDrill: 'Ø§Ù„ØªÙˆØ±Ø¨ÙŠÙ†: Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ³ÙˆØ³ ğŸ› ï¸',
        legendCleaner: 'Ø§Ù„Ù…Ù†Ø¸Ù: Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ù‚Ø¹ ğŸ§¹',
        legendFluoride: 'Ø§Ù„ÙÙ„ÙˆØ±Ø§ÙŠØ¯: Ù„ØªÙ‚ÙˆÙŠØ© Ø§Ù„Ø£Ø³Ù†Ø§Ù† ğŸ’§',
        legendHealthy: 'Ø³Ù† Ø³Ù„ÙŠÙ…: Ù„Ø§ ÙŠØ­ØªØ§Ø¬ Ø¹Ù„Ø§Ø¬ ğŸ¦·',
        legendCaries: 'Ø³Ù† Ù…ØªØ³ÙˆØ³: Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªÙˆØ±Ø¨ÙŠÙ† ğŸ¦·',
        legendStained: 'Ø³Ù† Ù…Ù„Ø·Ø®: Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ù†Ø¸Ù ğŸ¦·',
        welcome: 'Ù…Ø±Ø­Ø¨Ù‹Ø§! Ø§Ø³Ø­Ø¨ Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø³Ù†Ø§Ù† Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬ Ø¹Ù„Ø§Ø¬. ğŸ¦·',
        success: 'Ù…Ù…ØªØ§Ø²! ØªÙ… Ø§Ù„Ø¹Ù„Ø§Ø¬. ğŸ‰',
        patientComplete: 'Ø´ÙÙÙŠ Ø§Ù„Ù…Ø±ÙŠØ¶! ğŸŠ Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ§Ù„ÙŠØŸ',
        placeholder: 'Ø§Ø³Ø£Ù„ Ø§Ù„Ø·Ø¨ÙŠØ¨...',
        initialMessage: 'Ù…Ø±Ø­Ø¨Ù‹Ø§! Ø£Ù†Ø§ Ø¯. Ø¢Ù…Ù†Ø© Ø§Ù„Ø¬ÙˆØ§Ø¯ÙŠØŒ Ø·Ø¨ÙŠØ¨ØªÙƒ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©. Ù„Ù†Ø¨Ø¯Ø£ Ø¨ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø§Ø¨ØªØ³Ø§Ù…Ø§Øª! ğŸ˜Š'
      },
      es: {
        title: 'ClÃ­nica de la Sonrisa Perfecta ğŸ¦·',
        startBtn: 'ğŸš€ Iniciar Tratamiento',
        restartBtn: 'ğŸ”„ Nuevo Paciente',
        helpBtn: 'â“ Ayuda',
        toolsTitle: 'ğŸ› ï¸ Herramientas Dentales',
        patientTitle: 'ğŸ‘¤ Paciente Actual',
        legendTitle: 'ğŸ“‹ GuÃ­a de la ClÃ­nica',
        chatTitle: 'Dra. Amna Al-Jawadi',
        pointsLabel: 'Puntos',
        patientsLabel: 'Pacientes',
        levelLabel: 'Nivel',
        legendDrill: 'Taladro: Para eliminar caries ğŸ› ï¸',
        legendCleaner: 'Limpiador: Para quitar manchas ğŸ§¹',
        legendFluoride: 'FlÃºor: Para fortalecer dientes ğŸ’§',
        legendHealthy: 'Diente sano: No necesita tratamiento ğŸ¦·',
        legendCaries: 'Diente con caries: Usa el taladro ğŸ¦·',
        legendStained: 'Diente manchado: Usa el limpiador ğŸ¦·',
        welcome: 'Â¡Bienvenido! Arrastra las herramientas a los dientes que necesiten tratamiento. ğŸ¦·',
        success: 'Â¡Excelente! Tratamiento completado. ğŸ‰',
        patientComplete: 'Â¡Paciente curado! ğŸŠ Â¿Listo para el siguiente?',
        placeholder: 'Pregunta al doctor...',
        initialMessage: 'Â¡Hola! Soy la Dra. Amna Al-Jawadi, tu dentista virtual. Â¡Empecemos a mejorar sonrisas! ğŸ˜Š'
      },
      en: {
        title: 'Perfect Smile Clinic ğŸ¦·',
        startBtn: 'ğŸš€ Start Treatment',
        restartBtn: 'ğŸ”„ New Patient',
        helpBtn: 'â“ Help',
        toolsTitle: 'ğŸ› ï¸ Dental Tools',
        patientTitle: 'ğŸ‘¤ Current Patient',
        legendTitle: 'ğŸ“‹ Clinic Guide',
        chatTitle: 'Dr. Amna Al-Jawadi',
        pointsLabel: 'Points',
        patientsLabel: 'Patients',
        levelLabel: 'Level',
        legendDrill: 'Drill: To remove cavities ğŸ› ï¸',
        legendCleaner: 'Cleaner: To remove stains ğŸ§¹',
        legendFluoride: 'Fluoride: To strengthen teeth ğŸ’§',
        legendHealthy: 'Healthy tooth: No treatment needed ğŸ¦·',
        legendCaries: 'Caries tooth: Use the drill ğŸ¦·',
        legendStained: 'Stained tooth: Use the cleaner ğŸ¦·',
        welcome: 'Welcome! Drag tools to teeth that need treatment. ğŸ¦·',
        success: 'Excellent! Treatment completed. ğŸ‰',
        patientComplete: 'Patient cured! ğŸŠ Ready for the next one?',
        placeholder: 'Ask the doctor...',
        initialMessage: 'Hello! I\'m Dr. Amna Al-Jawadi, your virtual dentist. Let\'s start improving smiles! ğŸ˜Š'
      }
    };

    // Actualizar idioma
    function updateLanguage() {
      const t = translations[language];
      document.title = t.title.replace('ğŸ¦·', '');
      document.getElementById('title').textContent = t.title;
      startBtn.textContent = gameActive ? t.restartBtn : t.startBtn;
      helpBtn.textContent = t.helpBtn;
      document.getElementById('toolsTitle').textContent = t.toolsTitle;
      document.getElementById('legendTitle').textContent = t.legendTitle;
      document.getElementById('chatTitle').textContent = t.chatTitle;
      document.getElementById('pointsLabel').textContent = t.pointsLabel;
      document.getElementById('patientsLabel').textContent = t.patientsLabel;
      document.getElementById('levelLabel').textContent = t.levelLabel;
      document.getElementById('legendDrill').textContent = t.legendDrill;
      document.getElementById('legendCleaner').textContent = t.legendCleaner;
      document.getElementById('legendFluoride').textContent = t.legendFluoride;
      document.getElementById('legendHealthy').textContent = t.legendHealthy;
      document.getElementById('legendCaries').textContent = t.legendCaries;
      document.getElementById('legendStained').textContent = t.legendStained;
      document.getElementById('userInput').placeholder = t.placeholder;
      document.documentElement.lang = language;
      document.documentElement.dir = language === 'ar' ? 'rtl' : 'ltr';

      // Update legend icons dynamically as inline SVGs
      const icons = {
        drill: "<svg width='24' height='24' viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'><rect x='14' y='24' rx='6' ry='6' width='32' height='16' fill='#94a3b8' stroke='#0f172a' stroke-width='2'/><rect x='22' y='28' width='16' height='8' fill='#64748b'/><polygon points='46,28 54,32 46,36' fill='#bae6fd' stroke='#0f172a' stroke-width='2'/></svg>",
        cleaner: "<svg width='24' height='24' viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'><line x1='16' y1='46' x2='48' y2='18' stroke='#60a5fa' stroke-width='3'/><rect x='26' y='18' width='16' height='10' rx='3' fill='#93c5fd' stroke='#1e3a8a' stroke-width='2'/><line x1='28' y1='28' x2='28' y2='36' stroke='#1e3a8a' stroke-width='2'/><line x1='32' y1='28' x2='32' y2='36' stroke='#1e3a8a' stroke-width='2'/><line x1='36' y1='28' x2='36' y2='36' stroke='#1e3a8a' stroke-width='2'/></svg>",
        fluoride: "<svg width='24' height='24' viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'><defs><linearGradient id='g' x1='0' y1='0' x2='0' y2='1'><stop offset='0%' stop-color='#22d3ee'/><stop offset='100%' stop-color='#0ea5e9'/></linearGradient></defs><path d='M32 8 C40 16 42 24 32 40 C22 24 24 16 32 8 Z' fill='url(#g)' stroke='#075985' stroke-width='2'/></svg>",
        tooth: "<svg width='24' height='24' viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'><path d='M32 10c10 0 18 8 18 18s-6 12-8 20-3 10-6 10-4-5-5-9c-1-3-1-5-3-5s-2 2-3 5-3 9-6 9-4-2-6-10-8-10-8-20 8-18 18-18c4 0 6 2 9 2s5-2 8-2z' fill='white' stroke='#0f172a' stroke-width='2'/></svg>"
      };
      const setSvg = (id, svg) => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = svg;
      };
      setSvg('iconDrill', icons.drill);
      setSvg('iconCleaner', icons.cleaner);
      setSvg('iconFluoride', icons.fluoride);
      setSvg('iconHealthy', icons.tooth);
      setSvg('iconCaries', icons.tooth);
      setSvg('iconStained', icons.tooth);
    }
    langSelect.addEventListener('change', () => {
      language = langSelect.value;
      updateLanguage();
      addMessage(translations[language].initialMessage, 'bot');
    });
    updateLanguage();

    // Clase para dientes
    class Tooth {
      constructor(x, y, state) {
        this.x = x;
        this.y = y;
        this.width = 30;
        this.height = 50;
        this.state = state; // 'caries', 'stained', 'healthy'
      }

      draw() {
        ctx.save();
        ctx.font = '35px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        // Tooth icon (vector)
        ctx.translate(this.x, this.y);
        ctx.lineWidth = 2;
        ctx.strokeStyle = 'rgba(255,255,255,0.9)';
        ctx.fillStyle = 'rgba(255,255,255,0.95)';
        ctx.beginPath();
        ctx.moveTo(0, -18);
        ctx.bezierCurveTo(12, -18, 18, -8, 18, 2);
        ctx.bezierCurveTo(18, 12, 12, 14, 10, 22);
        ctx.bezierCurveTo(9, 26, 6, 28, 4, 28);
        ctx.bezierCurveTo(2, 28, 1, 26, 0, 22);
        ctx.bezierCurveTo(-1, 26, -2, 28, -4, 28);
        ctx.bezierCurveTo(-6, 28, -9, 26, -10, 22);
        ctx.bezierCurveTo(-12, 14, -18, 12, -18, 2);
        ctx.bezierCurveTo(-18, -8, -12, -18, 0, -18);
        ctx.closePath();
        ctx.fill();
        ctx.stroke();
        if (this.state === 'caries') {
          ctx.fillStyle = '#7c3aed';
          ctx.beginPath();
          ctx.arc(5, -6, 4, 0, Math.PI * 2);
          ctx.fill();
        } else if (this.state === 'stained') {
          ctx.fillStyle = '#f59e0b';
          ctx.beginPath();
          ctx.arc(5, -6, 4, 0, Math.PI * 2);
          ctx.fill();
        } else if (this.state === 'healthy') {
          ctx.globalAlpha = 1;
          const shine = ctx.createLinearGradient(0, -18, 0, 18);
          shine.addColorStop(0, 'rgba(255,255,255,0.9)');
          shine.addColorStop(1, 'rgba(255,255,255,0.6)');
          ctx.fillStyle = shine;
          ctx.beginPath();
          ctx.arc(-4, -10, 4, 0, Math.PI * 2);
          ctx.fill();
        }
        ctx.translate(-this.x, -this.y);
        ctx.restore();
      }

      isClicked(x, y) {
        return (
          x >= this.x - this.width / 2 &&
          x <= this.x + this.width / 2 &&
          y >= this.y - this.height / 2 &&
          y <= this.y + this.height / 2
        );
      }
    }

    // Clase para herramientas
    class Tool {
      constructor(type, x, y) {
        this.type = type;
        this.x = x;
        this.y = y;
        this.width = 40;
        this.height = 40;
        this.dragging = false;
      }

      draw() {
        ctx.save();
        // Render SVG-like icons programmatically for a more professional look
        if (this.type === 'drill') {
          // Drill icon
          ctx.translate(this.x, this.y);
          ctx.fillStyle = '#94a3b8';
          ctx.strokeStyle = '#0f172a';
          ctx.lineWidth = 2;
          // body
          ctx.beginPath();
          ctx.roundRect(-18, -10, 36, 20, 6);
          ctx.fill();
          ctx.stroke();
          // grip
          ctx.fillStyle = '#64748b';
          ctx.fillRect(-10, -6, 20, 12);
          // bit
          ctx.beginPath();
          ctx.moveTo(18, -4);
          ctx.lineTo(28, 0);
          ctx.lineTo(18, 4);
          ctx.closePath();
          ctx.fillStyle = '#bae6fd';
          ctx.fill();
          ctx.stroke();
          // cable
          ctx.beginPath();
          ctx.strokeStyle = 'rgba(56,189,248,0.6)';
          ctx.moveTo(-18, 0);
          ctx.bezierCurveTo(-28, -8, -34, 10, -44, 2);
          ctx.stroke();
          ctx.translate(-this.x, -this.y);
        } else if (this.type === 'cleaner') {
          // Cleaner brush icon
          ctx.translate(this.x, this.y);
          ctx.strokeStyle = '#0f172a';
          ctx.lineWidth = 2;
          // handle
          ctx.beginPath();
          ctx.moveTo(-16, 8);
          ctx.lineTo(16, -8);
          ctx.strokeStyle = '#60a5fa';
          ctx.stroke();
          // head
          ctx.fillStyle = '#93c5fd';
          ctx.strokeStyle = '#1e3a8a';
          ctx.beginPath();
          ctx.roundRect(-6, -12, 18, 10, 4);
          ctx.fill();
          ctx.stroke();
          // bristles
          ctx.strokeStyle = '#1e3a8a';
          for (let i = -5; i <= 9; i += 3) {
            ctx.beginPath();
            ctx.moveTo(i, -2);
            ctx.lineTo(i, 6);
            ctx.stroke();
          }
          ctx.translate(-this.x, -this.y);
        } else {
          // Fluoride droplet icon
          ctx.translate(this.x, this.y);
          const gradient = ctx.createLinearGradient(0, -16, 0, 16);
          gradient.addColorStop(0, '#22d3ee');
          gradient.addColorStop(1, '#0ea5e9');
          ctx.fillStyle = gradient;
          ctx.strokeStyle = '#075985';
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(0, -16);
          ctx.bezierCurveTo(10, -6, 12, 0, 0, 16);
          ctx.bezierCurveTo(-12, 0, -10, -6, 0, -16);
          ctx.fill();
          ctx.stroke();
          // sparkle
          ctx.strokeStyle = 'rgba(255,255,255,0.8)';
          ctx.beginPath();
          ctx.moveTo(-4, -2);
          ctx.lineTo(0, -6);
          ctx.lineTo(4, -2);
          ctx.stroke();
          ctx.translate(-this.x, -this.y);
        }
        if (this.dragging) {
          ctx.shadowColor = 'rgba(34, 197, 94, 0.8)';
          ctx.shadowBlur = 20;
        }
        ctx.restore();
      }

      isClicked(x, y) {
        return (
          x >= this.x - this.width / 2 &&
          x <= this.x + this.width / 2 &&
          y >= this.y - this.height / 2 &&
          y <= this.y + this.height / 2
        );
      }
    }

    // Dientes y herramientas
    const teeth = [];
    const tools = [
      new Tool('drill', 50, 60),
      new Tool('cleaner', 100, 60),
      new Tool('fluoride', 150, 60)
    ];

    // Control de arrastre
    let dragStart = null;
    function handleStart(e) {
      if (!gameActive) return;
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX || e.touches[0].clientX) - rect.left;
      const y = (e.clientY || e.touches[0].clientY) - rect.top;
      selectedTool = tools.find(tool => tool.isClicked(x, y));
      if (selectedTool) {
        selectedTool.dragging = true;
        dragStart = { x, y };
      }
    }

    function handleMove(e) {
      if (!gameActive || !selectedTool || !selectedTool.dragging) return;
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX || e.touches[0].clientX) - rect.left;
      const y = (e.clientY || e.touches[0].clientY) - rect.top;
      selectedTool.x += x - dragStart.x;
      selectedTool.y += y - dragStart.y;
      dragStart = { x, y };
    }

    function handleEnd(e) {
      if (!gameActive || !selectedTool) return;
      e.preventDefault();
      selectedTool.dragging = false;
      const targetTooth = teeth.find(tooth => tooth.isClicked(selectedTool.x, selectedTool.y));
      if (targetTooth) {
        if (
          (selectedTool.type === 'drill' && targetTooth.state === 'caries') ||
          (selectedTool.type === 'cleaner' && targetTooth.state === 'stained') ||
          (selectedTool.type === 'fluoride' && targetTooth.state !== 'healthy')
        ) {
          targetTooth.state = 'healthy';
          points += 10;
          pointsEl.textContent = points;
          addMessage(translations[language].success, 'bot');
          saveProgress();
          if (teeth.every(tooth => tooth.state === 'healthy')) {
            patients += 1;
            patientsEl.textContent = patients;
            level = Math.floor(patients / 2) + 1;
            levelEl.textContent = level;
            setTimeout(() => {
              addMessage(translations[language].patientComplete, 'bot');
              resetTeeth();
              saveProgress();
            }, 1500);
          }
        }
      }
      selectedTool.x = tools.indexOf(selectedTool) * 50 + 50;
      selectedTool.y = 60;
      selectedTool = null;
    }

    canvas.addEventListener('mousedown', handleStart);
    canvas.addEventListener('mousemove', handleMove);
    canvas.addEventListener('mouseup', handleEnd);
    canvas.addEventListener('touchstart', handleStart, { passive: false });
    canvas.addEventListener('touchmove', handleMove, { passive: false });
    canvas.addEventListener('touchend', handleEnd, { passive: false });

    // Iniciar juego
    function resetTeeth() {
      teeth.length = 0;
      const numTeeth = Math.min(3 + Math.floor(level / 2), 6);
      for (let i = 0; i < numTeeth; i++) {
        const state = Math.random() > 0.5 ? 'caries' : 'stained';
        teeth.push(new Tooth(100 + i * 80, 200, state));
      }
    }

    startBtn.addEventListener('click', () => {
      gameActive = true;
      if (patients === 0) {
        points = 0;
        patients = 0;
        level = 1;
        pointsEl.textContent = points;
        patientsEl.textContent = patients;
        levelEl.textContent = level;
        saveProgress();
      }
      resetTeeth();
      addMessage(translations[language].welcome, 'bot');
      startBtn.textContent = translations[language].restartBtn;
    });

    helpBtn.addEventListener('click', () => {
      addMessage(`${translations[language].legendDrill} ${translations[language].legendCleaner} ${translations[language].legendFluoride}`, 'bot');
    });

    // AnimaciÃ³n
    function animate() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      // Soft vignette background
      const radial = ctx.createRadialGradient(
        canvas.width / 2,
        canvas.height / 2,
        40,
        canvas.width / 2,
        canvas.height / 2,
        240
      );
      radial.addColorStop(0, 'rgba(255,255,255,0.06)');
      radial.addColorStop(1, 'rgba(0,0,0,0.08)');
      ctx.fillStyle = radial;
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      teeth.forEach(tooth => tooth.draw());
      tools.forEach(tool => tool.draw());
      requestAnimationFrame(animate);
    }
    animate();

    // Sistema de chat
    const responses = {
      ar: [
        'ØªÙ‚Ù†ÙŠØ© Ù…Ù…ØªØ§Ø²Ø©! Ø§Ù„Ø£Ø³Ù†Ø§Ù† ØªØ¨Ø¯Ùˆ Ø£ÙØ¶Ù„ Ø¨ÙƒØ«ÙŠØ±. ğŸ¦·âœ¨',
        'ØªØ°ÙƒØ±: Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ù…Ø±ØªÙŠÙ† ÙŠÙˆÙ…ÙŠØ§Ù‹ ÙŠØ¨Ø¹Ø¯ Ø§Ù„ØªØ³ÙˆØ³. ğŸª¥',
        'Ø¹Ù…Ù„ Ø¬ÙŠØ¯! Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±ÙŠØ¶ Ø³ÙŠØ­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ø¨ØªØ³Ø§Ù…Ø© Ù…Ø´Ø±Ù‚Ø©. ğŸ˜Š',
        'Ø§Ù„ÙÙ„ÙˆØ±Ø§ÙŠØ¯ Ù‡Ùˆ Ø£ÙØ¶Ù„ Ø­Ù„ÙŠÙ Ø¶Ø¯ Ø§Ù„ØªØ³ÙˆØ³. ğŸ’ª',
        'Ø§Ø³ØªÙ…Ø± Ù‡ÙƒØ°Ø§! ÙƒÙ„ Ø³Ù† Ø³Ù„ÙŠÙ… Ù‡Ùˆ Ø§Ù†ØªØµØ§Ø±. ğŸ†'
      ],
      es: [
        'Â¡Excelente tÃ©cnica! Los dientes se ven mucho mejor. ğŸ¦·âœ¨',
        'Recuerda: cepillado 2 veces al dÃ­a mantiene alejadas las caries. ğŸª¥',
        'Â¡Buen trabajo! Este paciente tendrÃ¡ una sonrisa radiante. ğŸ˜Š',
        'El flÃºor es tu mejor aliado contra las caries. ğŸ’ª',
        'Â¡Sigue asÃ­! Cada diente sano es una victoria. ğŸ†'
      ],
      en: [
        'Excellent technique! The teeth look much better. ğŸ¦·âœ¨',
        'Remember: brushing twice a day keeps cavities away. ğŸª¥',
        'Good job! This patient will have a radiant smile. ğŸ˜Š',
        'Fluoride is your best ally against cavities. ğŸ’ª',
        'Keep it up! Every healthy tooth is a victory. ğŸ†'
      ]
    };

    function addMessage(message, sender) {
      const messageEl = document.createElement('div');
      messageEl.className = `
