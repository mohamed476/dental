<!DOCTYPE html>
<html lang="ar" dir="rtl" id="html">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>عيادة الابتسامة المثالية</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><path fill='%23ffffff' stroke='%23000000' stroke-width='2' d='M32 6c9 0 20 6 20 18 0 12-7 14-9 22-2 8-3 12-7 12-4 0-5-6-6-10-1-4-1-6-3-6s-2 2-3 6c-1 4-2 10-6 10-4 0-5-4-7-12-2-8-9-10-9-22C2 12 13 6 22 6c4 0 6 2 10 2s6-2 10-2z'/></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    @keyframes glow {
      0%, 100% { box-shadow: 0 0 5px rgba(34, 197, 94, 0.5); }
      50% { box-shadow: 0 0 20px rgba(34, 197, 94, 0.8), 0 0 30px rgba(34, 197, 94, 0.6); }
    }
    @keyframes sparkle {
      0%, 100% { opacity: 1; transform: scale(1) rotate(0deg); }
      50% { opacity: 0.5; transform: scale(1.2) rotate(180deg); }
    }
    .tool:hover {
      transform: scale(1.1);
      animation: float 2s ease-in-out infinite;
    }
    .tool.dragging {
      transform: scale(1.2);
      animation: glow 1s ease-in-out infinite;
    }
    .tooth.healthy {
      animation: sparkle 3s ease-in-out infinite;
    }
    .game-area {
      background: linear-gradient(135deg, #4b5563 0%, #6b7280 100%);
      border-radius: 20px;
      padding: 1rem;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }
    @media (min-width: 768px) {
      .game-area {
        padding: 2rem;
      }
    }
    .stats-card {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    canvas { 
      touch-action: none; 
      border-radius: 8px; 
      max-width: 100%;
      height: auto;
    }
    .legend-img { 
      width: 20px; 
      height: 20px; 
      font-size: 20px; 
      line-height: 20px; 
      text-align: center; 
    }
    @media (min-width: 768px) {
      .legend-img {
        width: 24px;
        height: 24px;
        font-size: 24px;
        line-height: 24px;
      }
    }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(to bottom right, #6b7280, #4b5563, #374151);
      min-height: 100vh;
      padding: 0.5rem;
      overflow-x: hidden;
    }
    @media (min-width: 768px) {
      body {
        padding: 1rem;
      }
    }
    /* Mobile optimizations */
    .mobile-title {
      font-size: 1.75rem;
      line-height: 2rem;
    }
    @media (min-width: 768px) {
      .mobile-title {
        font-size: 3rem;
        line-height: 1;
      }
    }
    .mobile-stats {
      gap: 0.5rem;
    }
    @media (min-width: 768px) {
      .mobile-stats {
        gap: 1rem;
      }
    }
    .mobile-buttons {
      flex-direction: column;
      gap: 0.5rem;
    }
    @media (min-width: 768px) {
      .mobile-buttons {
        flex-direction: row;
        gap: 1rem;
      }
    }
    .mobile-grid {
      grid-template-columns: 1fr;
    }
    @media (min-width: 768px) {
      .mobile-grid {
        grid-template-columns: 1fr 1fr;
      }
    }
    .mobile-chat {
      height: 24vh;
    }
    @media (min-width: 768px) {
      .mobile-chat {
        height: 32vh;
      }
    }
    /* Prevent zoom on input focus */
    input, select, textarea {
      font-size: 16px !important;
    }
    /* Better touch targets */
    button, select {
      min-height: 44px;
    }
    /* Smooth scrolling */
    html {
      scroll-behavior: smooth;
    }
  </style>
</head>
<body>
  <div class="max-w-4xl mx-auto">
    <!-- Encabezado -->
    <div class="text-center mb-4 md:mb-8">
      <h1 class="mobile-title font-bold bg-gradient-to-r from-cyan-300 to-purple-300 bg-clip-text text-transparent mb-3 md:mb-4" id="title">عيادة الابتسامة المثالية 🦷</h1>
      <select id="langSelect" class="mb-4 md:mb-6 p-2 md:p-3 bg-white/20 backdrop-blur border border-white/30 rounded-lg text-white text-sm md:text-base" aria-label="اختيار اللغة">
        <option value="ar">العربية</option>
        <option value="es">Español</option>
        <option value="en">English</option>
      </select>
      <div class="flex justify-center mobile-stats mb-4 md:mb-6">
        <div class="stats-card rounded-xl px-3 py-2 md:px-6 md:py-3">
          <div class="text-lg md:text-2xl font-bold text-cyan-200" id="points">0</div>
          <div class="text-xs md:text-sm text-white/80" id="pointsLabel">نقاط الصحة</div>
        </div>
        <div class="stats-card rounded-xl px-3 py-2 md:px-6 md:py-3">
          <div class="text-lg md:text-2xl font-bold text-green-200" id="patients">0</div>
          <div class="text-xs md:text-sm text-white/80" id="patientsLabel">المرضى</div>
        </div>
        <div class="stats-card rounded-xl px-3 py-2 md:px-6 md:py-3">
          <div class="text-lg md:text-2xl font-bold text-purple-200" id="level">1</div>
          <div class="text-xs md:text-sm text-white/80" id="levelLabel">المستوى</div>
        </div>
      </div>
      <div class="flex mobile-buttons justify-center">
        <button id="startBtn" class="bg-gradient-to-r from-green-400 to-emerald-500 text-white px-6 py-3 md:px-8 md:py-4 rounded-xl hover:from-green-500 hover:to-emerald-600 transition-all duration-300 shadow-lg transform hover:scale-105 text-sm md:text-base" aria-label="بدء أو إعادة اللعبة">🚀 ابدأ العلاج</button>
        <button id="helpBtn" class="bg-white/20 backdrop-blur text-white px-6 py-3 md:px-8 md:py-4 rounded-xl hover:bg-white/30 transition-all duration-300 text-sm md:text-base" aria-label="عرض المساعدة">❓ مساعدة</button>
      </div>
    </div>

    <!-- Área de Juego -->
    <div class="game-area mb-4 md:mb-8">
      <div class="text-center mb-4 md:mb-6">
        <h2 class="text-lg md:text-2xl font-bold text-white mb-3 md:mb-4" id="toolsTitle">🛠️ أدوات الأسنان</h2>
        <canvas id="canvas" width="350" height="250" class="mx-auto" aria-label="منطقة اللعب"></canvas>
      </div>
    </div>

    <!-- Leyenda y Chat -->
    <div class="grid mobile-grid gap-4 md:gap-6">
      <!-- Leyenda -->
      <div class="stats-card rounded-2xl p-4 md:p-6">
        <h3 class="text-lg md:text-xl font-bold text-white mb-3 md:mb-4" id="legendTitle">📋 دليل العيادة</h3>
        <div class="space-y-2 md:space-y-3 text-white/90 text-sm md:text-base">
          <div class="flex items-center gap-2 md:gap-3">
            <span class="legend-img" id="iconDrill"></span>
            <span id="legendDrill">التوربين: لإزالة التسوس</span>
          </div>
          <div class="flex items-center gap-2 md:gap-3">
            <span class="legend-img" id="iconCleaner"></span>
            <span id="legendCleaner">المنظف: لإزالة البقع</span>
          </div>
          <div class="flex items-center gap-2 md:gap-3">
            <span class="legend-img" id="iconFluoride"></span>
            <span id="legendFluoride">الفلورايد: لتقوية الأسنان</span>
          </div>
          <div class="flex items-center gap-2 md:gap-3">
            <span class="legend-img" id="iconHealthy"></span>
            <span id="legendHealthy">سن سليم: لا يحتاج علاج</span>
          </div>
          <div class="flex items-center gap-2 md:gap-3">
            <span class="legend-img" id="iconCaries"></span>
            <span id="legendCaries">سن متسوس: استخدم التوربين</span>
          </div>
          <div class="flex items-center gap-2 md:gap-3">
            <span class="legend-img" id="iconStained"></span>
            <span id="legendStained">سن ملطخ: استخدم المنظف</span>
          </div>
        </div>
      </div>

      <!-- Chat -->
      <div class="stats-card rounded-2xl p-4 md:p-6">
        <div class="flex items-center mb-3 md:mb-4">
          <div class="w-10 h-10 md:w-12 md:h-12 bg-gradient-to-r from-cyan-300 to-purple-300 rounded-full flex items-center justify-center mr-2 md:mr-3">
            <span class="text-lg md:text-2xl">👨‍⚕️</span>
          </div>
          <h3 class="text-lg md:text-xl font-bold text-white" id="chatTitle">د. آمنة الجوادي</h3>
        </div>
        <div id="chatBox" class="mobile-chat overflow-y-auto bg-white/10 rounded-lg p-2 md:p-3 mb-3 md:mb-4 backdrop-blur border border-white/20 text-white text-xs md:text-sm" aria-live="polite"></div>
        <div class="flex gap-2">
          <input id="userInput" type="text" class="flex-1 p-2 md:p-3 bg-white/20 border border-white/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-300 text-white placeholder-gray-200 backdrop-blur text-sm md:text-base" placeholder="اسأل الطبيب..." aria-label="إدخال رسالة للدردشة">
          <button id="sendBtn" class="bg-gradient-to-r from-cyan-400 to-purple-500 text-white px-3 py-2 md:px-4 md:py-3 rounded-lg hover:from-cyan-500 hover:to-purple-600 transition-all duration-300 text-sm md:text-base" aria-label="إرسال رسالة">📨</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configuración del lienzo responsive
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    // Ajustar canvas para móviles
    function resizeCanvas() {
      const container = canvas.parentElement;
      const maxWidth = Math.min(container.clientWidth - 40, 400);
      const maxHeight = Math.min(window.innerHeight * 0.3, 300);
      
      if (window.innerWidth < 768) {
        canvas.width = maxWidth;
        canvas.height = maxHeight;
      } else {
        canvas.width = 400;
        canvas.height = 300;
      }
    }
    
    // Resize inicial y en cambio de orientación
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
    window.addEventListener('orientationchange', () => {
      setTimeout(resizeCanvas, 100);
    });

    const pointsEl = document.getElementById('points');
    const patientsEl = document.getElementById('patients');
    const levelEl = document.getElementById('level');
    const startBtn = document.getElementById('startBtn');
    const helpBtn = document.getElementById('helpBtn');
    const langSelect = document.getElementById('langSelect');
    const chatBox = document.getElementById('chatBox');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');

    let points = 0;
    let patients = 0;
    let level = 1;
    let gameActive = false;
    let selectedTool = null;
    let language = 'ar';

    // Traducciones
    const translations = {
      ar: {
        title: 'عيادة الابتسامة المثالية 🦷',
        startBtn: '🚀 ابدأ العلاج',
        restartBtn: '🔄 مريض جديد',
        helpBtn: '❓ مساعدة',
        toolsTitle: '🛠️ أدوات الأسنان',
        patientTitle: '👤 المريض الحالي',
        legendTitle: '📋 دليل العيادة',
        chatTitle: 'د. آمنة الجوادي',
        pointsLabel: 'نقاط الصحة',
        patientsLabel: 'المرضى',
        levelLabel: 'المستوى',
        legendDrill: 'التوربين: لإزالة التسوس',
        legendCleaner: 'المنظف: لإزالة البقع',
        legendFluoride: 'الفلورايد: لتقوية الأسنان',
        legendHealthy: 'سن سليم: لا يحتاج علاج',
        legendCaries: 'سن متسوس: استخدم التوربين',
        legendStained: 'سن ملطخ: استخدم المنظف',
        welcome: 'مرحبًا! اسحب الأدوات إلى الأسنان التي تحتاج علاج. 🦷',
        success: 'ممتاز! تم العلاج. 🎉',
        patientComplete: 'شُفي المريض! 🎊 جاهز للتالي؟',
        placeholder: 'اسأل الطبيب...',
        initialMessage: 'مرحبًا! أنا د. آمنة الجوادي، طبيبتك الافتراضية. لنبدأ بتحسين الابتسامات! 😊'
      },
      es: {
        title: 'Clínica de la Sonrisa Perfecta 🦷',
        startBtn: '🚀 Iniciar Tratamiento',
        restartBtn: '🔄 Nuevo Paciente',
        helpBtn: '❓ Ayuda',
        toolsTitle: '🛠️ Herramientas Dentales',
        patientTitle: '👤 Paciente Actual',
        legendTitle: '📋 Guía de la Clínica',
        chatTitle: 'Dra. Amna Al-Jawadi',
        pointsLabel: 'Puntos',
        patientsLabel: 'Pacientes',
        levelLabel: 'Nivel',
        legendDrill: 'Taladro: Para eliminar caries',
        legendCleaner: 'Limpiador: Para quitar manchas',
        legendFluoride: 'Flúor: Para fortalecer dientes',
        legendHealthy: 'Diente sano: No necesita tratamiento',
        legendCaries: 'Diente con caries: Usa el taladro',
        legendStained: 'Diente manchado: Usa el limpiador',
        welcome: '¡Bienvenido! Arrastra las herramientas a los dientes que necesiten tratamiento. 🦷',
        success: '¡Excelente! Tratamiento completado. 🎉',
        patientComplete: '¡Paciente curado! 🎊 ¿Listo para el siguiente?',
        placeholder: 'Pregunta al doctor...',
        initialMessage: '¡Hola! Soy la Dra. Amna Al-Jawadi, tu dentista virtual. ¡Empecemos a mejorar sonrisas! 😊'
      },
      en: {
        title: 'Perfect Smile Clinic 🦷',
        startBtn: '🚀 Start Treatment',
        restartBtn: '🔄 New Patient',
        helpBtn: '❓ Help',
        toolsTitle: '🛠️ Dental Tools',
        patientTitle: '👤 Current Patient',
        legendTitle: '📋 Clinic Guide',
        chatTitle: 'Dr. Amna Al-Jawadi',
        pointsLabel: 'Points',
        patientsLabel: 'Patients',
        levelLabel: 'Level',
        legendDrill: 'Drill: To remove cavities',
        legendCleaner: 'Cleaner: To remove stains',
        legendFluoride: 'Fluoride: To strengthen teeth',
        legendHealthy: 'Healthy tooth: No treatment needed',
        legendCaries: 'Caries tooth: Use the drill',
        legendStained: 'Stained tooth: Use the cleaner',
        welcome: 'Welcome! Drag tools to teeth that need treatment. 🦷',
        success: 'Excellent! Treatment completed. 🎉',
        patientComplete: 'Patient cured! 🎊 Ready for the next one?',
        placeholder: 'Ask the doctor...',
        initialMessage: 'Hello! I\'m Dr. Amna Al-Jawadi, your virtual dentist. Let\'s start improving smiles! 😊'
      }
    };

    // Actualizar idioma
    function updateLanguage() {
      const t = translations[language];
      document.title = t.title.replace('🦷', '');
      document.getElementById('title').textContent = t.title;
      startBtn.textContent = gameActive ? t.restartBtn : t.startBtn;
      helpBtn.textContent = t.helpBtn;
      document.getElementById('toolsTitle').textContent = t.toolsTitle;
      document.getElementById('legendTitle').textContent = t.legendTitle;
      document.getElementById('chatTitle').textContent = t.chatTitle;
      document.getElementById('pointsLabel').textContent = t.pointsLabel;
      document.getElementById('patientsLabel').textContent = t.patientsLabel;
      document.getElementById('levelLabel').textContent = t.levelLabel;
      document.getElementById('legendDrill').textContent = t.legendDrill;
      document.getElementById('legendCleaner').textContent = t.legendCleaner;
      document.getElementById('legendFluoride').textContent = t.legendFluoride;
      document.getElementById('legendHealthy').textContent = t.legendHealthy;
      document.getElementById('legendCaries').textContent = t.legendCaries;
      document.getElementById('legendStained').textContent = t.legendStained;
      document.getElementById('userInput').placeholder = t.placeholder;
      document.documentElement.lang = language;
      document.documentElement.dir = language === 'ar' ? 'rtl' : 'ltr';

      // Update legend icons dynamically as inline SVGs
      const icons = {
        drill: "<svg width='20' height='20' viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'><rect x='14' y='24' rx='6' ry='6' width='32' height='16' fill='#94a3b8' stroke='#0f172a' stroke-width='2'/><rect x='22' y='28' width='16' height='8' fill='#64748b'/><polygon points='46,28 54,32 46,36' fill='#bae6fd' stroke='#0f172a' stroke-width='2'/></svg>",
        cleaner: "<svg width='20' height='20' viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'><line x1='16' y1='46' x2='48' y2='18' stroke='#60a5fa' stroke-width='3'/><rect x='26' y='18' width='16' height='10' rx='3' fill='#93c5fd' stroke='#1e3a8a' stroke-width='2'/><line x1='28' y1='28' x2='28' y2='36' stroke='#1e3a8a' stroke-width='2'/><line x1='32' y1='28' x2='32' y2='36' stroke='#1e3a8a' stroke-width='2'/><line x1='36' y1='28' x2='36' y2='36' stroke='#1e3a8a' stroke-width='2'/></svg>",
        fluoride: "<svg width='20' height='20' viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'><defs><linearGradient id='g' x1='0' y1='0' x2='0' y2='1'><stop offset='0%' stop-color='#22d3ee'/><stop offset='100%' stop-color='#0ea5e9'/></linearGradient></defs><path d='M32 8 C40 16 42 24 32 40 C22 24 24 16 32 8 Z' fill='url(#g)' stroke='#075985' stroke-width='2'/></svg>",
        tooth: "<svg width='20' height='20' viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'><path d='M32 10c10 0 18 8 18 18s-6 12-8 20-3 10-6 10-4-5-5-9c-1-3-1-5-3-5s-2 2-3 5-3 9-6 9-4-2-6-10-8-10-8-20 8-18 18-18c4 0 6 2 9 2s5-2 8-2z' fill='white' stroke='#0f172a' stroke-width='2'/></svg>"
      };
      
      if (window.innerWidth >= 768) {
        icons.drill = icons.drill.replace('width="20" height="20"', 'width="24" height="24"');
        icons.cleaner = icons.cleaner.replace('width="20" height="20"', 'width="24" height="24"');
        icons.fluoride = icons.fluoride.replace('width="20" height="20"', 'width="24" height="24"');
        icons.tooth = icons.tooth.replace('width="20" height="20"', 'width="24" height="24"');
      }
      
      const setSvg = (id, svg) => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = svg;
      };
      setSvg('iconDrill', icons.drill);
      setSvg('iconCleaner', icons.cleaner);
      setSvg('iconFluoride', icons.fluoride);
      setSvg('iconHealthy', icons.tooth);
      setSvg('iconCaries', icons.tooth);
      setSvg('iconStained', icons.tooth);
    }

    langSelect.addEventListener('change', () => {
      language = langSelect.value;
      updateLanguage();
      addMessage(translations[language].initialMessage, 'bot');
    });
    updateLanguage();

    // Clase para dientes
    class Tooth {
      constructor(x, y, state) {
        this.x = x;
        this.y = y;
        this.width = 30;
        this.height = 50;
        this.state = state; // 'caries', 'stained', 'healthy'
      }

      draw() {
        ctx.save();
        ctx.font = '35px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        // Tooth icon (vector)
        ctx.translate(this.x, this.y);
        ctx.lineWidth = 2;
        ctx.strokeStyle = 'rgba(255,255,255,0.9)';
        ctx.fillStyle = 'rgba(255,255,255,0.95)';
        ctx.beginPath();
        ctx.moveTo(0, -18);
        ctx.bezierCurveTo(12, -18, 18, -8, 18, 2);
        ctx.bezierCurveTo(18, 12, 12, 14, 10, 22);
        ctx.bezierCurveTo(9, 26, 6, 28, 4, 28);
        ctx.bezierCurveTo(2, 28, 1, 26, 0, 22);
        ctx.bezierCurveTo(-1, 26, -2, 28, -4, 28);
        ctx.bezierCurveTo(-6, 28, -9, 26, -10, 22);
        ctx.bezierCurveTo(-12, 14, -18, 12, -18, 2);
        ctx.bezierCurveTo(-18, -8, -12, -18, 0, -18);
        ctx.closePath();
        ctx.fill();
        ctx.stroke();
        if (this.state === 'caries') {
          ctx.fillStyle = '#7c3aed';
          ctx.beginPath();
          ctx.arc(5, -6, 4, 0, Math.PI * 2);
          ctx.fill();
        } else if (this.state === 'stained') {
          ctx.fillStyle = '#f59e0b';
          ctx.beginPath();
          ctx.arc(5, -6, 4, 0, Math.PI * 2);
          ctx.fill();
        } else if (this.state === 'healthy') {
          ctx.globalAlpha = 1;
          const shine = ctx.createLinearGradient(0, -18, 0, 18);
          shine.addColorStop(0, 'rgba(255,255,255,0.9)');
          shine.addColorStop(1, 'rgba(255,255,255,0.6)');
          ctx.fillStyle = shine;
          ctx.beginPath();
          ctx.arc(-4, -10, 4, 0, Math.PI * 2);
          ctx.fill();
        }
        ctx.translate(-this.x, -this.y);
        ctx.restore();
      }

      isClicked(x, y) {
        return (
          x >= this.x - this.width / 2 &&
          x <= this.x + this.width / 2 &&
          y >= this.y - this.height / 2 &&
          y <= this.y + this.height / 2
        );
      }
    }

    // Clase para herramientas
    class Tool {
      constructor(type, x, y) {
        this.type = type;
        this.x = x;
        this.y = y;
        this.width = 40;
        this.height = 40;
        this.dragging = false;
      }

      draw() {
        ctx.save();
        // Render SVG-like icons programmatically for a more professional look
        if (this.type === 'drill') {
          // Drill icon
          ctx.translate(this.x, this.y);
          ctx.fillStyle = '#94a3b8';
          ctx.strokeStyle = '#0f172a';
          ctx.lineWidth = 2;
          // body
          ctx.beginPath();
          ctx.roundRect(-18, -10, 36, 20, 6);
          ctx.fill();
          ctx.stroke();
          // grip
          ctx.fillStyle = '#64748b';
          ctx.fillRect(-10, -6, 20, 12);
          // bit
          ctx.beginPath();
          ctx.moveTo(18, -4);
          ctx.lineTo(28, 0);
          ctx.lineTo(18, 4);
          ctx.closePath();
          ctx.fillStyle = '#bae6fd';
          ctx.fill();
          ctx.stroke();
          // cable
          ctx.beginPath();
          ctx.strokeStyle = 'rgba(56,189,248,0.6)';
          ctx.moveTo(-18, 0);
          ctx.bezierCurveTo(-28, -8, -34, 10, -44, 2);
          ctx.stroke();
          ctx.translate(-this.x, -this.y);
        } else if (this.type === 'cleaner') {
          // Cleaner brush icon
          ctx.translate(this.x, this.y);
          ctx.strokeStyle = '#0f172a';
          ctx.lineWidth = 2;
          // handle
          ctx.beginPath();
          ctx.moveTo(-16, 8);
          ctx.lineTo(16, -8);
          ctx.strokeStyle = '#60a5fa';
          ctx.stroke();
          // head
          ctx.fillStyle = '#93c5fd';
          ctx.strokeStyle = '#1e3a8a';
          ctx.beginPath();
          ctx.roundRect(-6, -12, 18, 10, 4);
          ctx.fill();
          ctx.stroke();
          // bristles
          ctx.strokeStyle = '#1e3a8a';
          for (let i = -5; i <= 9; i += 3) {
            ctx.beginPath();
            ctx.moveTo(i, -2);
            ctx.lineTo(i, 6);
            ctx.stroke();
          }
          ctx.translate(-this.x, -this.y);
        } else {
          // Fluoride droplet icon
          ctx.translate(this.x, this.y);
          const gradient = ctx.createLinearGradient(0, -16, 0, 16);
          gradient.addColorStop(0, '#22d3ee');
          gradient.addColorStop(1, '#0ea5e9');
          ctx.fillStyle = gradient;
          ctx.strokeStyle = '#075985';
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(0, -16);
          ctx.bezierCurveTo(10, -6, 12, 0, 0, 16);
          ctx.bezierCurveTo(-12, 0, -10, -6, 0, -16);
          ctx.fill();
          ctx.stroke();
          // sparkle
          ctx.strokeStyle = 'rgba(255,255,255,0.8)';
          ctx.beginPath();
          ctx.moveTo(-4, -2);
          ctx.lineTo(0, -6);
          ctx.lineTo(4, -2);
          ctx.stroke();
          ctx.translate(-this.x, -this.y);
        }
        if (this.dragging) {
          ctx.shadowColor = 'rgba(34, 197, 94, 0.8)';
          ctx.shadowBlur = 20;
        }
        ctx.restore();
      }

      isClicked(x, y) {
        return (
          x >= this.x - this.width / 2 &&
          x <= this.x + this.width / 2 &&
          y >= this.y - this.height / 2 &&
          y <= this.y + this.height / 2
        );
      }
    }

    // Dientes y herramientas
    const teeth = [];
    const tools = [
      new Tool('drill', 50, 60),
      new Tool('cleaner', 100, 60),
      new Tool('fluoride', 150, 60)
    ];

    // Control de arrastre
    let dragStart = null;
    function handleStart(e) {
      if (!gameActive) return;
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX || e.touches[0].clientX) - rect.left;
      const y = (e.clientY || e.touches[0].clientY) - rect.top;
      selectedTool = tools.find(tool => tool.isClicked(x, y));
      if (selectedTool) {
        selectedTool.dragging = true;
        dragStart = { x, y };
      }
    }

    function handleMove(e) {
      if (!gameActive || !selectedTool || !selectedTool.dragging) return;
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX || e.touches[0].clientX) - rect.left;
      const y = (e.clientY || e.touches[0].clientY) - rect.top;
      selectedTool.x += x - dragStart.x;
      selectedTool.y += y - dragStart.y;
      dragStart = { x, y };
    }

    function handleEnd(e) {
      if (!gameActive || !selectedTool) return;
      e.preventDefault();
      selectedTool.dragging = false;
      const targetTooth = teeth.find(tooth => tooth.isClicked(selectedTool.x, selectedTool.y));
      if (targetTooth) {
        if (
          (selectedTool.type === 'drill' && targetTooth.state === 'caries') ||
          (selectedTool.type === 'cleaner' && targetTooth.state === 'stained') ||
          (selectedTool.type === 'fluoride' && targetTooth.state !== 'healthy')
        ) {
          targetTooth.state = 'healthy';
          points += 10;
          pointsEl.textContent = points;
          addMessage(translations[language].success, 'bot');
          saveProgress();
          if (teeth.every(tooth => tooth.state === 'healthy')) {
            patients += 1;
            patientsEl.textContent = patients;
            level = Math.floor(patients / 2) + 1;
            levelEl.textContent = level;
            setTimeout(() => {
              addMessage(translations[language].patientComplete, 'bot');
              resetTeeth();
              saveProgress();
            }, 1500);
          }
        }
      }
      selectedTool.x = tools.indexOf(selectedTool) * 50 + 50;
      selectedTool.y = 60;
      selectedTool = null;
    }

    canvas.addEventListener('mousedown', handleStart);
    canvas.addEventListener('mousemove', handleMove);
    canvas.addEventListener('mouseup', handleEnd);
    canvas.addEventListener('touchstart', handleStart, { passive: false });
    canvas.addEventListener('touchmove', handleMove, { passive: false });
    canvas.addEventListener('touchend', handleEnd, { passive: false });

    // Iniciar juego
    function resetTeeth() {
      teeth.length = 0;
      const numTeeth = Math.min(3 + Math.floor(level / 2), 6);
      const spacing = canvas.width / (numTeeth + 1);
      for (let i = 0; i < numTeeth; i++) {
        const state = Math.random() > 0.5 ? 'caries' : 'stained';
        teeth.push(new Tooth(spacing * (i + 1), canvas.height * 0.7, state));
      }
    }

    startBtn.addEventListener('click', () => {
      gameActive = true;
      if (patients === 0) {
        points = 0;
        patients = 0;
        level = 1;
        pointsEl.textContent = points;
        patientsEl.textContent = patients;
        levelEl.textContent = level;
        saveProgress();
      }
      resetTeeth();
      addMessage(translations[language].welcome, 'bot');
      startBtn.textContent = translations[language].restartBtn;
    });

    helpBtn.addEventListener('click', () => {
      addMessage(`${translations[language].legendDrill} ${translations[language].legendCleaner} ${translations[language].legendFluoride}`, 'bot');
    });

    // Animación
    function animate() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      // Soft vignette background
      const radial = ctx.createRadialGradient(
        canvas.width / 2,
        canvas.height / 2,
        40,
        canvas.width / 2,
        canvas.height / 2,
        240
      );
      radial.addColorStop(0, 'rgba(255,255,255,0.06)');
      radial.addColorStop(1, 'rgba(0,0,0,0.08)');
      ctx.fillStyle = radial;
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      teeth.forEach(tooth => tooth.draw());
      tools.forEach(tool => tool.draw());
      requestAnimationFrame(animate);
    }
    animate();

    // Sistema de chat
    const responses = {
      ar: [
        'تقنية ممتازة! الأسنان تبدو أفضل بكثير. 🦷✨',
        'تذكر: التنظيف مرتين يومياً يبعد التسوس. 🪥',
        'عمل جيد! هذا المريض سيحصل على ابتسامة مشرقة. 😊',
        'الفلورايد هو أفضل حليف ضد التسوس. 💪',
        'استمر هكذا! كل سن سليم هو انتصار. 🏆'
      ],
      es: [
        '¡Excelente técnica! Los dientes se ven mucho mejor. 🦷✨',
        'Recuerda: cepillado 2 veces al día mantiene alejadas las caries. 🪥',
        '¡Buen trabajo! Este paciente tendrá una sonrisa radiante. 😊',
        'El flúor es tu mejor aliado contra las caries. 💪',
        '¡Sigue así! Cada diente sano es una victoria. 🏆'
      ],
      en: [
        'Excellent technique! The teeth look much better. 🦷✨',
        'Remember: brushing twice a day keeps cavities away. 🪥',
        'Good job! This patient will have a radiant smile. 😊',
        'Fluoride is your best ally against cavities. 💪',
        'Keep it up! Every healthy tooth is a victory. 🏆'
      ]
    };

    function addMessage(message, sender) {
      const messageEl = document.createElement('div');
      messageEl.className = `mb-2 p-2 rounded-lg ${sender === 'user' ? 'bg-cyan-500/30 text-cyan-100' : 'bg-purple-500/30 text-purple-100'}`;
      const label = sender === 'user' ? (language === 'ar' ? 'أنت' : language === 'es' ? 'Tú' : 'You') : translations[language].chatTitle;
      const strongEl = document.createElement('strong');
      strongEl.textContent = `${label}: `;
      messageEl.appendChild(strongEl);
      messageEl.appendChild(document.createTextNode(message));
      chatBox.appendChild(messageEl);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function saveProgress() {
      localStorage.setItem('dentalGame', JSON.stringify({
        points,
        patients,
        level,
        language
      }));
    }

    function loadProgress() {
      const saved = localStorage.getItem('dentalGame');
      if (saved) {
        const data = JSON.parse(saved);
        points = data.points || 0;
        patients = data.patients || 0;
        level = data.level || 1;
        language = data.language || 'ar';
        pointsEl.textContent = points;
        patientsEl.textContent = patients;
        levelEl.textContent = level;
        langSelect.value = language;
        updateLanguage();
      }
    }

    // Chat functionality
    sendBtn.addEventListener('click', () => {
      const message = userInput.value.trim();
      if (message) {
        addMessage(message, 'user');
        userInput.value = '';
        setTimeout(() => {
          const randomResponse = responses[language][Math.floor(Math.random() * responses[language].length)];
          addMessage(randomResponse, 'bot');
        }, 1000);
      }
    });

    userInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendBtn.click();
      }
    });

    // Load progress and show initial message
    loadProgress();
    addMessage(translations[language].initialMessage, 'bot');
  </script>
</body>
</html>
